<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="./icon.png" />
    <link rel="stylesheet" href="./src/css/style.css" />
    <link rel="stylesheet" href="./src/css/leaderboard.css" />

    <title>X O Game</title>
  </head>

  <body>
    <img
      id="game-logo"
      src="./src/images/logo.png"
      alt="Game Logo"
      style="
        display: block;
        margin: 30px auto 10px auto;
        width: 360px;
        max-width: 90vw;
      "
    />

    <div class="top-bar">
      <label class="switch">
        <input type="checkbox" id="theme-toggle" />
        <span class="slider"></span>
      </label>
      <button id="env-toggle" style="margin-left: 12px; font-size: 12px; padding: 6px 10px;">Env: dev</button>
    <!-- Minimal ENV toggle: sets window.env.VITE_ENV and reloads -->
      <div class="segmented-toggle" id="game-mode-toggle">
        <input
          type="radio"
          id="vsComputer"
          name="gameMode"
          value="playerVsComputer"
          checked
        />
        <label for="vsComputer" class="segmented-option">
          üéÆ&nbsp;Play vs Computer
        </label>
        <input
          type="radio"
          id="vsPlayer"
          name="gameMode"
          value="playerVsPlayer"
        />
        <label for="vsPlayer" class="segmented-option">
          üßë‚Äçü§ù‚Äçüßë&nbsp;Play vs Friend
        </label>
        <span class="segmented-slider"></span>
      </div>
    </div>

    <div id="game-board" class="board"></div>
    <div id="game-over-message"></div>
    <div class="button-group">
      <button id="restart-button" aria-label="Play Again"></button>
      <button id="reset-score-button" aria-label="Reset Score"></button>
      <button id="leaderboard-button" aria-label="Show Leaderboard">
        üèÜ Leaderboard
      </button>
    </div>

    <!-- Leaderboard Modal -->
    <!-- <div id="leaderboard-modal" class="leaderboard-modal" style="display: none">
      <div class="leaderboard-content">
        <span class="leaderboard-close">&times;</span>
        <h2>üèÜ Leaderboard</h2>
        <div id="leaderboard-list" class="leaderboard-list">
          <p>Memuat leaderboard...</p>
        </div>
      </div>
    </div> -->

    <div id="leaderboard-full" style="display:none" class="leaderboard-fullscreen">
      
      <div class="leaderboard-box">

        <div class="profile-header">
          <img id="profile-avatar" class="profile-avatar" src="./src/images/default-avatar.png" />
          <div id="profile-email" class="profile-email">email@gmail.com</div>
          <div id="profile-rank" class="profile-rank">Leaderboard : 1st</div>
        </div>

        <div class="top-title">Top Leaderboard</div>

        <table class="leaderboard-table">
          <thead>
            <tr>
              <th>Rank</th>
              <th>User</th>
              <th>Win</th>
              <th>Lose</th>
              <th>Draw</th>
              <th>Time</th>
              <th>Score</th>
            </tr>
          </thead>

          <tbody id="leaderboard-body">
            <tr><td colspan="7" style="text-align:center;color:white">Loading...</td></tr>
          </tbody>
        </table>

        <button id="close-leaderboard" class="logout-btn">Back</button>

      </div>
    </div>
    <script src="./src/js/leaderboard-ui.js"></script>
    
    <!-- Firebase Scripts (CDN SDK) + Config (local env switch) -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import { getAuth } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import {
        getFirestore,
        collection,
        addDoc,
        query,
        orderBy,
        limit,
        where,
        getDocs,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
      import { firebaseConfig, environment } from "./src/js/firebase.browser.config.js";

      // Initialize from environment-aware config
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // Store globally for leaderboard.js
      window.firebaseApp = app;
      window.firebaseAuth = auth;
      window.firebaseDb = db;
      window.firebaseEnv = environment;

      // Export Firestore functions untuk leaderboard.js
      window.firestore = {
        collection,
        addDoc,
        query,
        orderBy,
        limit,
        where,
        getDocs,
        serverTimestamp,
      };
    </script>

    <script src="./src/js/gameLogic.js"></script>
    <script type="module" src="./src/js/leaderboard.js"></script>
    <script src="./src/js/script.js"></script>
    <script>
      window.va =
        window.va ||
        function () {
          (window.vaq = window.vaq || []).push(arguments);
        };
    </script>
    <!-- <script defer src="/_vercel/insights/script.js"></script> -->
    <script>
      window.si =
        window.si ||
        function () {
          (window.siq = window.siq || []).push(arguments);
        };
    </script>
    <!-- <script defer src="/_vercel/speed-insights/script.js"></script> -->
    <!-- <script>
      // Leaderboard functionality
      (function () {
        const leaderboardButton = document.getElementById("leaderboard-button");
        const leaderboardModal = document.getElementById("leaderboard-modal");
        const leaderboardClose = document.querySelector(".leaderboard-close");
        const leaderboardList = document.getElementById("leaderboard-list");

        function formatTimestamp(timestamp) {
          if (!timestamp) return "N/A";
          if (timestamp.toDate) {
            // Firestore Timestamp
            const date = timestamp.toDate();
            return date.toLocaleString("id-ID");
          }
          return new Date(timestamp).toLocaleString("id-ID");
        }

        function formatTime(seconds) {
          if (!seconds) return "0s";
          const mins = Math.floor(seconds / 60);
          const secs = seconds % 60;
          return mins > 0 ? `${mins}m ${secs}s` : `${secs}s`;
        }

        async function loadLeaderboard() {
          leaderboardList.innerHTML = "<p>Memuat leaderboard...</p>";

          if (!window.leaderboardService) {
            leaderboardList.innerHTML =
              "<p>Leaderboard service belum tersedia. Silakan refresh halaman.</p>";
            return;
          }

          try {
            const leaderboard = await window.leaderboardService.getLeaderboard(
              10
            );

            if (leaderboard.length === 0) {
              leaderboardList.innerHTML =
                "<p>Belum ada data leaderboard. Mainkan game untuk menambahkan score!</p>";
              return;
            }

            let html = "";
            leaderboard.forEach((item) => {
              const rank = item.rank || 1;
              const email = item.userEmail || "Anonymous";
              const totalHumanScore = item.totalHumanScore || 0;
              const totalComputerScore = item.totalComputerScore || 0;
              const winCount = item.winCount || 0;
              const drawCount = item.drawCount || 0;
              const loseCount = item.loseCount || 0;
              const gameCount = item.gameCount || 0;
              const totalGameTime = formatTime(item.totalGameTime || 0);

              // Format waktu rekap (dari session start sampai session end)
              let sessionTime = "N/A";
              if (item.sessionStart && item.sessionEnd) {
                const startTime = item.sessionStart.toDate
                  ? item.sessionStart.toDate()
                  : new Date(item.sessionStart);
                const endTime = item.sessionEnd.toDate
                  ? item.sessionEnd.toDate()
                  : new Date(item.sessionEnd);
                const sessionDuration = Math.floor(
                  (endTime - startTime) / 1000
                ); // dalam detik
                sessionTime = formatTime(sessionDuration);
              }

              // Format timestamp rekap
              const sessionStartTime = formatTimestamp(item.sessionStart);
              const sessionEndTime = formatTimestamp(item.sessionEnd);

              html += `
                <div class="leaderboard-item">
                  <div class="leaderboard-item-rank">#${rank}</div>
                  <div class="leaderboard-item-info">
                    <div class="leaderboard-item-email">${email}</div>
                    <div class="leaderboard-item-scores">
                      Total Score: ${totalHumanScore} - ${totalComputerScore} | Games: ${gameCount}
                    </div>
                    <div class="leaderboard-item-scores" style="margin-top: 4px;">
                      üèÜ Menang: ${winCount} | ü§ù Draw: ${drawCount} | üòî Kalah: ${loseCount}
                    </div>
                    <div class="leaderboard-item-scores" style="font-size: 12px; color: #999; margin-top: 4px;">
                      Waktu Rekap: ${sessionTime} | Mulai: ${sessionStartTime}
                    </div>
                  </div>
                </div>
              `;
            });

            leaderboardList.innerHTML = html;
          } catch (error) {
            console.error("Error loading leaderboard:", error);
            leaderboardList.innerHTML =
              "<p>Gagal memuat leaderboard. Silakan coba lagi.</p>";
          }
        }

        if (leaderboardButton) {
          leaderboardButton.addEventListener("click", () => {
            leaderboardModal.style.display = "block";
            loadLeaderboard();
          });
        }

        if (leaderboardClose) {
          leaderboardClose.addEventListener("click", () => {
            leaderboardModal.style.display = "none";
          });
        }

        // Close modal when clicking outside
        if (leaderboardModal) {
          leaderboardModal.addEventListener("click", (e) => {
            if (e.target === leaderboardModal) {
              leaderboardModal.style.display = "none";
            }
          });
        }
      })();
    </script> -->
    <script>
      // Theme toggle logic - using existing themeToggle from script.js
      (function () {
        const logo = document.getElementById("game-logo");
        const lightLogo = "./src/images/logo.png";
        const darkLogo = "./src/images/logo-dark.png";
        const body = document.body;

        function updateTheme() {
          const themeToggle = document.getElementById("theme-toggle");
          if (!themeToggle) return;

          if (themeToggle.checked) {
            if (logo) logo.src = darkLogo;
            body.classList.add("dark-mode");
          } else {
            if (logo) logo.src = lightLogo;
            body.classList.remove("dark-mode");
          }
          // Paksa refresh style cells
          document.querySelectorAll(".cell").forEach((cell) => {
            // Ini akan memicu browser untuk re-apply CSS
            cell.classList.remove("force-refresh");
            void cell.offsetWidth; // trigger reflow
            cell.classList.add("force-refresh");
            setTimeout(() => cell.classList.remove("force-refresh"), 10);
          });
        }

        // Wait for DOM to be ready
        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", () => {
            const themeToggle = document.getElementById("theme-toggle");
            if (themeToggle) {
              themeToggle.addEventListener("change", updateTheme);
              updateTheme();
            }
          });
        } else {
          const themeToggle = document.getElementById("theme-toggle");
          if (themeToggle) {
            themeToggle.addEventListener("change", updateTheme);
            updateTheme();
          }
        }
      })();
    </script>
  </body>
</html>
