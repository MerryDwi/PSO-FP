<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="./icon.png" />
    <link rel="stylesheet" href="./src/css/style.css" />
    <link rel="stylesheet" href="./src/css/leaderboard.css" />

    <title>X O Game</title>
  </head>

  <body>
    
    <div class="theme-toggle-wrapper">
      <div class="timer-display" id="timer-display">
        ‚è±Ô∏è <span id="timer-text">00:00</span>
      </div>
      <label class="switch">
        <input type="checkbox" id="theme-toggle" />
        <span class="slider"></span>
      </label>
    </div>

    
    <img
      id="game-logo"
      src="./src/images/logo.png"
      alt="Game Logo"
      style="
        display: block;
        margin: 30px auto 10px auto;
        width: 360px;
        max-width: 90vw;
      "
    />

   
    <div class="game-mode-wrapper">
      <div class="segmented-toggle" id="game-mode-toggle">
        <input
          type="radio"
          id="vsComputer"
          name="gameMode"
          value="playerVsComputer"
          checked
        />
        <label for="vsComputer" class="segmented-option">
          üéÆ&nbsp;Play vs Computer
        </label>
        <input
          type="radio"
          id="vsPlayer"
          name="gameMode"
          value="playerVsPlayer"
        />
        <label for="vsPlayer" class="segmented-option">
          üßë‚Äçü§ù‚Äçüßë&nbsp;Play vs Friend
        </label>
        <span class="segmented-slider"></span>
      </div>
    </div>

    <div id="game-board" class="board"></div>
    <div id="game-over-message"></div>
    <div class="button-group">
      <button id="restart-button" aria-label="Play Again"></button>
      <button id="reset-score-button" aria-label="Reset Score"></button>
      <button id="leaderboard-button" aria-label="Show Leaderboard">
        üèÜ Leaderboard
      </button>
      <button id="test-write-button" aria-label="Test Firestore Write">üß™ Test Write</button>
    </div>

    <div id="test-write-result" style="margin: 10px auto; max-width: 640px; font-size: 13px; line-height: 1.4; display:none;"></div>

    <div id="leaderboard-full" style="display:none" class="leaderboard-fullscreen">
      
      <div class="leaderboard-box">

        <div class="profile-header">
          <img id="profile-avatar" class="profile-avatar" src="./src/images/default-avatar.png" />
          <div id="profile-email" class="profile-email">email@gmail.com</div>
          <div id="profile-rank" class="profile-rank">Leaderboard : 1st</div>
        </div>

        <div class="top-title">Top Leaderboard</div>

        <table class="leaderboard-table">
          <thead>
            <tr>
              <th>Rank</th>
              <th>User</th>
              <th>Win</th>
              <th>Lose</th>
              <th>Draw</th>
              <th>Time</th>
              <th>Score</th>
            </tr>
          </thead>

          <tbody id="leaderboard-body">
            <tr><td colspan="7" style="text-align:center;color:white">Loading...</td></tr>
          </tbody>
        </table>

        <button id="close-leaderboard" class="logout-btn">Back</button>

      </div>
    </div>
    <script src="./src/js/leaderboard-ui.js"></script>
    
    <!-- Firebase Scripts (CDN SDK) + Config (local env switch) -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import { getAuth } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import {
        getFirestore,
        collection,
        addDoc,
        doc,
        setDoc,
        query,
        orderBy,
        limit,
        where,
        getDocs,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
      import { firebaseConfig, environment } from "./src/js/firebase.browser.config.js";

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      window.firebaseApp = app;
      window.firebaseAuth = auth;
      window.firebaseDb = db;
      window.firebaseEnv = environment;

      window.firestore = {
        collection,
        addDoc,
        doc,
        setDoc,
        query,
        orderBy,
        limit,
        where,
        getDocs,
        serverTimestamp,
      };

      const testBtn = document.getElementById("test-write-button");
      const resultBox = document.getElementById("test-write-result");
      if (testBtn) {
        testBtn.addEventListener("click", async () => {
          resultBox.style.display = "block";
          resultBox.textContent = "Running test write...";
          try {
            if (!auth || !db) {
              throw new Error("Firebase belum diinisialisasi (auth/db missing)");
            }
            const user = auth.currentUser;
            if (!user) {
              throw new Error("User belum login. Silakan login di index.html terlebih dahulu.");
            }
            const { collection, addDoc, serverTimestamp } = window.firestore || {};
            if (!collection || !addDoc || !serverTimestamp) {
              throw new Error("Firestore functions belum tersedia di window.firestore");
            }
            const payload = {
              userId: user.uid,
              userEmail: user.email || null,
              humanScore: 1,
              computerScore: 0,
              gameTime: 5,
              result: "win",
              timestamp: serverTimestamp(),
              gameMode: "playerVsComputer",
              debug: { env: window.firebaseEnv, time: new Date().toISOString() },
            };
            const docRef = await addDoc(collection(db, "leaderboard"), payload);
            resultBox.style.color = "#0a7";
            resultBox.textContent = `‚úÖ Test write success. Doc ID: ${docRef.id}`;
          } catch (err) {
            console.error("Test write error:", err);
            resultBox.style.color = "#c00";
            resultBox.textContent = `‚ùå Test write failed: ${err && err.message ? err.message : err}`;
          }
        });
      }
    </script>

    <script src="./src/js/gameLogic.js"></script>
    <script type="module" src="./src/js/leaderboard.js"></script>
    <script src="./src/js/script.js"></script>
    <script>
      window.va =
        window.va ||
        function () {
          (window.vaq = window.vaq || []).push(arguments);
        };
    </script>
    <script>
      window.si =
        window.si ||
        function () {
          (window.siq = window.siq || []).push(arguments);
        };
    </script>
    <script>
      // Theme toggle logic
      (function () {
        const logo = document.getElementById("game-logo");
        const lightLogo = "./src/images/logo.png";
        const darkLogo = "./src/images/logo-dark.png";
        const body = document.body;

        function updateTheme() {
          const themeToggle = document.getElementById("theme-toggle");
          if (!themeToggle) return;

          if (themeToggle.checked) {
            if (logo) logo.src = darkLogo;
            body.classList.add("dark-mode");
          } else {
            if (logo) logo.src = lightLogo;
            body.classList.remove("dark-mode");
          }
          document.querySelectorAll(".cell").forEach((cell) => {
            cell.classList.remove("force-refresh");
            void cell.offsetWidth;
            cell.classList.add("force-refresh");
            setTimeout(() => cell.classList.remove("force-refresh"), 10);
          });
        }

        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", () => {
            const themeToggle = document.getElementById("theme-toggle");
            if (themeToggle) {
              themeToggle.addEventListener("change", updateTheme);
              updateTheme();
            }
          });
        } else {
          const themeToggle = document.getElementById("theme-toggle");
          if (themeToggle) {
            themeToggle.addEventListener("change", updateTheme);
            updateTheme();
          }
        }
      })();
    </script>
    
    <script>
      // Timer functionality
      (function() {
        let timerInterval = null;
        let startTime = null;
        let isRunning = false;

        const timerText = document.getElementById('timer-text');

        function formatTime(seconds) {
          const mins = Math.floor(seconds / 60);
          const secs = seconds % 60;
          return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        function updateTimer() {
          if (!startTime) return;
          const elapsed = Math.floor((Date.now() - startTime) / 1000);
          timerText.textContent = formatTime(elapsed);
        }

        function startTimer() {
          if (isRunning) return;
          isRunning = true;
          startTime = Date.now();
          timerInterval = setInterval(updateTimer, 1000);
        }

        function stopTimer() {
          if (!isRunning) return;
          isRunning = false;
          clearInterval(timerInterval);
          timerInterval = null;
        }

        function resetTimer() {
          stopTimer();
          startTime = null;
          timerText.textContent = '00:00';
        }

        // Expose timer functions globally
        window.gameTimer = {
          start: startTimer,
          stop: stopTimer,
          reset: resetTimer,
          getElapsedTime: () => {
            if (!startTime) return 0;
            return Math.floor((Date.now() - startTime) / 1000);
          }
        };

        // Auto-start timer when game starts (optional)
        // You can call window.gameTimer.start() from your game logic
      })();
    </script>
  </body>
</html>